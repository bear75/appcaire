# Scheduling Logic & Trial Comparison

## Overview
This document outlines the technical approach for implementing schedule comparison functionality, allowing trial organizations to compare their manual schedules with AI-optimized alternatives.

## 1. Data Model

### Schedule Types
```typescript
enum ScheduleType {
  MANUAL = 'MANUAL',      // Imported from eCare/Carefox
  OPTIMIZED = 'OPTIMIZED' // Generated by Timefold.ai
}

enum ScheduleStatus {
  DRAFT = 'DRAFT',
  PUBLISHED = 'PUBLISHED',
  ARCHIVED = 'ARCHIVED'
}

enum ImportSource {
  ECARE_JSON = 'ECARE_JSON',
  ECARE_API = 'ECARE_API',
  CAREFOX = 'CAREFOX',
  CSV = 'CSV'
}
```

### Database Schema Extensions
```typescript
interface Schedule {
  id: string
  organizationId: string
  type: ScheduleType
  status: ScheduleStatus
  startDate: Date
  endDate: Date
  metadata: {
    source: ImportSource
    importedAt: Date
    importMethod?: 'JSON_UPLOAD' | 'DIRECT_API'
    optimizationScore?: {  // For OPTIMIZED schedules only
      travelTime: number
      staffUtilization: number
      constraintSatisfaction: number
    }
  }
}

interface ScheduleComparison {
  id: string
  organizationId: string
  manualScheduleId: string
  optimizedScheduleId: string
  metrics: {
    travelTimeReduction: number
    staffUtilizationImprovement: number
    constraintSatisfactionRate: number
  }
  createdAt: Date
  status: 'PENDING' | 'COMPLETED'
}

// eCare Schedule Format
interface ECareScheduleEntry {
  date: string
  groupId: string
  clientId: string
  employeeId: string
  startTime: string
  endTime: string
  category?: string
}
```

## 2. UI Components

### Schedule Import
```typescript
interface ImportWizardProps {
  onImportComplete: (scheduleId: string) => void
}

// Components:
- ImportWizard
  - ImportMethodSelector (JSON/API)
  - JsonImportForm
    - JsonEditor (with validation)
    - FormatInstructions
  - ImportStatus
    - ValidationResults
    - ImportProgress
```

### Schedule Page Layout
```typescript
interface SchedulePageProps {
  organizationId: string
  isTrialOrg: boolean
  hasImportedSchedule: boolean
  hasOptimizedSchedule: boolean
}

// Components:
- ScheduleHeader
  - DateRangePicker
  - ViewToggle (Day/Week/Month)
  - CompareButton (shown for trial orgs)
  
- ScheduleView
  - SingleScheduleView (default)
  - ComparisonView (when comparison mode is active)
    - ManualSchedulePanel
    - OptimizedSchedulePanel
    - DifferenceHighlighter
```

### Comparison Mode UI
- Split screen layout (50/50)
- Synchronized scrolling between panels
- Color-coded differences:
  - Green: Improved assignments
  - Yellow: Changed assignments
  - Red: Constraint violations

### Trial-Specific Elements
- Trial badge/banner
- ROI metrics panel
- "Upgrade to Pro" CTA
- Schedule import wizard

## 3. Core Functions

### Schedule Import
```typescript
// JSON Import
async function importJsonSchedule(
  organizationId: string,
  jsonContent: string
): Promise<ValidationResult> {
  // 1. Validate JSON format
  // 2. Validate against eCare schema
  // 3. Transform to internal format
  // 4. Store in database
}

// Schema Validation
interface ValidationResult {
  isValid: boolean
  errors: ValidationError[]
  transformedData?: Schedule
}

// Data Transformation
function transformECareSchedule(
  data: ECareScheduleEntry[]
): InternalScheduleFormat {
  // Transform eCare format to internal format
}
```

### Optimization Request
```typescript
async function requestOptimizedSchedule(
  organizationId: string,
  manualScheduleId: string,
  constraints: ScheduleConstraints
): Promise<Schedule>
```

### Comparison Generation
```typescript
async function generateComparison(
  organizationId: string,
  manualScheduleId: string,
  optimizedScheduleId: string
): Promise<ScheduleComparison>
```

## 4. User Flows

### Trial Organization Flow
1. Organization signs up for trial
2. Imports existing schedule:
   - Paste eCare JSON export
   - Validate format
   - Transform and store
3. Views manual schedule in standard view
4. Requests AI optimization
5. Toggles comparison view
6. Reviews differences and improvements
7. (Optional) Publishes optimized schedule

### Schedule Import Flow
1. User selects import method (JSON upload)
2. For JSON upload:
   - User pastes eCare schedule JSON
   - System validates format
   - Shows validation results
   - Transforms data on success
3. System stores imported schedule
4. User reviews imported schedule
5. User can request optimization

### Schedule Publishing Flow
1. Review optimized schedule
2. Accept/reject specific changes
3. Generate final schedule
4. Push back to source system (eCare/Carefox)

## 5. Metrics & Analytics

### Comparison Metrics
- Travel time reduction (%)
- Staff utilization improvement (%)
- Constraint satisfaction rate (%)
- Schedule stability (% of assignments unchanged)

### Trial Conversion Metrics
- Number of comparisons generated
- Average improvement metrics
- Time spent in comparison view
- Optimization request frequency

## 6. Implementation Phases

### Phase 1: Basic Import & Comparison
- JSON schedule import
- Basic validation
- Simple side-by-side view
- Basic metrics calculation

### Phase 2: Enhanced Visualization
- Interactive difference highlighting
- Detailed metrics breakdown
- Synchronized scrolling

### Phase 3: Advanced Features
- Direct eCare API integration
- Partial change acceptance
- What-if scenarios
- Custom constraint weighting

## 7. Technical Considerations

### Performance
- Lazy loading of schedule data
- Cached comparison results
- Optimized diff calculation
- JSON validation optimization

### Security
- Organization data isolation
- Trial feature access control
- Audit logging of schedule changes
- JSON content validation

### Integration
- eCare JSON format validation
- Future eCare API integration
- Timefold.ai optimization parameters
- Export format standardization

## 8. eCare Integration Details

### JSON Format Requirements
```json
{
  "scheduleEntries": [
    {
      "date": "2024-01-25",
      "groupId": "string",
      "clientId": "string",
      "employeeId": "string",
      "startTime": "08:00",
      "endTime": "09:00",
      "category": "string"
    }
  ]
}
```

### Validation Rules
1. Required fields:
   - date (YYYY-MM-DD)
   - startTime (HH:mm)
   - endTime (HH:mm)
   - employeeId
   - clientId
2. Optional fields:
   - category
   - groupId
3. Business rules:
   - startTime must be before endTime
   - date must be valid
   - IDs must be non-empty strings

### Error Handling
- Invalid JSON format
- Missing required fields
- Invalid date/time formats
- Business rule violations
- Transformation errors 